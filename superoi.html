<html>
  <head>
    <style>
      .chart {
        background-color: #292929;
        display: flex;
        flex-direction: column;
      }
      .abs {
        position: absolute;
        right: 0;
        bottom: 0;
      }
    </style>
  </head>
  <body style="background-color: #424242">
    <div style="display: flex; flex-direction: row; height: 100%">
      <audio id="success">
        <source src="./ok.mp3" type="audio/mpeg" />
      </audio>
      <audio id="error">
        <source src="./error.mp3" type="audio/mpeg" />
      </audio>
      <div style="flex: 0.8; height: 50%" class="chart">
        <span id="chngPCR" style="color: white"> PCR: 0 </span>
        <canvas id="coiline"></canvas>
        <canvas id="coiChart"></canvas>
      </div>
      <div style="flex: 0.8; height: 50%" class="chart">
        <div
          style="
            flex-direction: row;
            justify-content: space-around;
            display: flex;
          "
        >
          <span id="PCR" style="color: white"> PCR: 0 </span>
          <div>
            <span style="color: white"> Ticker: </span>
            <select onchange="setTicker(this.value)" id="ticker"></select>
          </div>
        </div>
        <canvas id="oiline"></canvas>
        <canvas id="oiChart"></canvas>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      let xValues = [];
      let oiData = [];
      let coiData = [];
      let coiColor = "white";
      let coiline = new Chart("coiline", {
        type: "line",
        data: {
          labels: xValues,
          datasets: [
            {
              label: "Change in OI PCR",
              data: [860, 1140, 1060, 1060, 1070, 1110, 1330, 2210, 7830, 2478],
              borderColor: coiColor,
              fill: false,
            },
          ],
        },
        options: {
          legend: { display: false },
        },
      });
      let oiColor = "white";
      let oiline = new Chart("oiline", {
        type: "line",
        data: {
          labels: xValues,
          datasets: [
            {
              label: "PCR",
              data: [
                1600, 1700, 1700, 1900, 2000, 2700, 4000, 5000, 6000, 7000,
              ],
              borderColor: oiColor,
              fill: false,
            },
          ],
        },
        options: {
          legend: { display: false },
        },
      });
      let ticker = "NIFTY";
      function setTicker(e) {
        ticker = e;
        setOi();
        lastPCR = 0;
      }
      let Mode = "openInterest";
      function setMode(e) {
        Mode = e;
        setOi();
      }
      fetch("https://v2-api.niftychain.in/api/get-tickers")
        .then((data) => data.json())
        .then((data) => {
          let tickerEl = document.getElementById("ticker");
          data.data.forEach((e) => {
            if (e.Name == "NIFTY")
              tickerEl.innerHTML += `<option selected="selected" value="${e.Name}">${e.Name}</option>`;
            else
              tickerEl.innerHTML += `<option value="${e.Name}">${e.Name}</option>`;
          });
        });
      const ctx = document.getElementById("oiChart");
      const coictx = document.getElementById("coiChart");
      let lastPCR = 0;
      let lastchngPCR = 0;

      const data = {
        labels: [2, "4311", "4571", "4588"],
        datasets: [
          {
            data: [5996, 4605, 1288, 3463, 5996, 4605, 1288, 3463],
            backgroundColor: [
              "rgba(245, 48, 32, 0.55)",
              "rgba(37, 255, 32, 0.55)",
              "rgba(245, 48, 32, 0.55)",
              "rgba(37, 255, 32, 0.55)",
              "rgba(245, 48, 32, 0.55)",
              "rgba(37, 255, 32, 0.55)",
              "rgba(245, 48, 32, 0.55)",
              "rgba(37, 255, 32, 0.55)",
            ],
            borderColor: [
              "rgba(245, 48, 32, 0.8)",
              "rgba(37, 255, 32, 0.55)",
              "rgba(245, 48, 32, 0.8)",
              "rgba(37, 255, 32, 0.55)",
              "rgba(245, 48, 32, 0.8)",
              "rgba(37, 255, 32, 0.55)",
              "rgba(245, 48, 32, 0.8)",
              "rgba(37, 255, 32, 0.55)",
            ],
          },
        ],
      };

      Chart.defaults.color = "white";
      let oiChart = new Chart(ctx, {
        type: "bar",
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
          tooltips: {
            callbacks: {
              label: (tooltipItem, data) => {
                let i = tooltipItem.index;
                return data.productNames[i] + ": " + data.datasets[0].data[i];
              },
            },
          },
        },
        data: data,
      });
      let coiChart = new Chart(coictx, {
        type: "bar",
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
          tooltips: {
            callbacks: {
              label: (tooltipItem, data) => {
                let i = tooltipItem.index;
                return data.productNames[i] + ": " + data.datasets[0].data[i];
              },
            },
          },
        },
        data: data,
      });

      function setOi() {
        fetch("https://v2-api.niftychain.in/api/live-data", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          },
          body: "ticker=" + ticker,
        }).then(async (data) => {
          let hehe = await data.json();
          let stkDiff =
            hehe.data.data[1].strikePrice - hehe.data.data[0].strikePrice;
          let stkprice =
            Math.round(hehe.data.underlyingValue / stkDiff) * stkDiff;
          let pSum = 0;
          let cSum = 0;
          let pcSum = 0;
          let ccSum = 0;
          for (let x = 0; x < hehe.data.data.length; x++) {
            cSum += hehe.data.data[x].ce.openInterest;
            pSum += hehe.data.data[x].pe.openInterest;
            ccSum += hehe.data.data[x].ce.changeinOpenInterest;
            pcSum += hehe.data.data[x].pe.changeinOpenInterest;
            if (hehe.data.data[x].strikePrice == stkprice) {
              addData(
                oiChart,
                [
                  hehe.data.data[x - 1].ce.openInterest,
                  hehe.data.data[x - 1].pe.openInterest,
                  hehe.data.data[x].ce.openInterest,
                  hehe.data.data[x].pe.openInterest,
                  hehe.data.data[x + 1].ce.openInterest,
                  hehe.data.data[x + 1].pe.openInterest,
                ],
                [
                  hehe.data.data[x - 1].strikePrice,
                  hehe.data.data[x - 1].strikePrice,
                  hehe.data.data[x].strikePrice,
                  hehe.data.data[x].strikePrice,
                  hehe.data.data[x + 1].strikePrice,
                  hehe.data.data[x + 1].strikePrice,
                ],
                0
              );
              addData(
                coiChart,
                [
                  hehe.data.data[x - 1].ce.changeinOpenInterest,
                  hehe.data.data[x - 1].pe.changeinOpenInterest,
                  hehe.data.data[x].ce.changeinOpenInterest,
                  hehe.data.data[x].pe.changeinOpenInterest,
                  hehe.data.data[x + 1].ce.changeinOpenInterest,
                  hehe.data.data[x + 1].pe.changeinOpenInterest,
                ],
                [
                  hehe.data.data[x - 1].strikePrice,
                  hehe.data.data[x - 1].strikePrice,
                  hehe.data.data[x].strikePrice,
                  hehe.data.data[x].strikePrice,
                  hehe.data.data[x + 1].strikePrice,
                  hehe.data.data[x + 1].strikePrice,
                ],
                0
              );
            }
          }
          let pcr = Math.round((pSum / cSum) * 1000) / 1000;
          let cpcr = Math.round((pcSum / ccSum) * 1000) / 1000;
          if (oiData.length == 0) {
            var date = new Date();

            var minutes = date.getMinutes();
            var hour = date.getHours();
            for (let i = 0; i < 10; i++) {
              oiData.push(pcr);
              coiData.push(cpcr);
              xValues.push(hour + ":" + minutes);
            }
          } else {
            var date = new Date();

            var minutes = date.getMinutes();
            var hour = date.getHours();
            let curTime = hour + ":" + minutes;
            console.log(curTime);
            if (xValues[xValues.length - 1] != curTime) {
              oiData.shift();
              coiData.shift();
              xValues.shift();
              xValues.push(curTime);
              oiData.push(pcr);
              coiData.push(cpcr);
            } else {
              oiData.pop();
              coiData.pop();
              oiData.push(pcr);
              coiData.push(cpcr);
            }
          }

          addData(oiline, oiData, xValues, 0);
          addData(coiline, coiData, xValues, 0);
          document.getElementById("PCR").innerHTML = "PCR: " + pcr;
          document.getElementById("chngPCR").innerHTML =
            "Change in OI PCR: " + cpcr;
        });
      }
      setOi();
      setInterval(() => {
        setOi();
      }, 10000);

      function addData(chart, data, labels, datasetIndex) {
        chart.data.datasets[datasetIndex].data = data;
        chart.data.labels = labels;
        chart.update();
      }
    </script>
  </body>
</html>
